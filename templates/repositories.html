{% extends "base.html" %}

{% block title %}Repositories{% endblock %}

{% block content %}
<div class="container">
    <div class="header">
        <h1>Monitored Repositories</h1>
        <p>Manage your repository monitoring settings</p>
    </div>

    <!-- Notification Area -->
    {% if request.query_params.get("scan_started") %}
    <div class="alert alert-info alert-dismissible fade show">
        Scan started successfully! You'll receive an email when complete.
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endif %}
    
    {% if request.query_params.get("error") == "no_token" %}
    <div class="alert alert-danger alert-dismissible fade show">
        Failed to start scan: GitHub access token missing
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endif %}

    <!-- Scan notifications -->
    {% if scan_notification %}
    <div class="alert alert-{{ scan_notification.type }} alert-dismissible fade show">
        {{ scan_notification.message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endif %}

    {% if scan_success %}
    <div class="alert alert-success alert-dismissible fade show">
        Repository scanned successfully!
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endif %}
    
    {% if scan_complete %}
    <div class="alert alert-info alert-dismissible fade show">
        Scan completed successfully! No new findings detected.
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endif %}
    
    {% if scan_error %}
    <div class="alert alert-danger alert-dismissible fade show">
        Failed to scan repository. Please try again.
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endif %}

    {% if github_repos %}
    <div class="github-repos-section mt-4">
        <h2>Your GitHub Repositories</h2>
        <div class="repositories-grid">
            {% for repo in github_repos %}
            <div class="card mb-3">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="card-title">{{ repo.name }}</h5>
                            <span class="badge bg-success">Connected</span>
                        </div>
                    </div>
                    
                    <div class="mt-2">
                        <p class="mb-1"><strong>URL:</strong> <a href="{{ repo.html_url }}" target="_blank">{{ repo.html_url }}</a></p>
                    </div>
                    
                    <div class="mt-3">
                        <button class="btn btn-sm btn-primary" 
                                onclick="addRepository('{{ repo.name }}', '{{ repo.html_url }}')">
                            Add to Monitoring
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteRepository('{{ repo._id }}')">
                            Delete
                        </button>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    {% if repositories %}
    <div class="repositories-list mt-4">
        <h2>Currently Monitored Repositories</h2>
        <div class="list-group">
            {% for repo in repositories %}
            <div class="list-group-item">
                <div class="d-flex w-100 justify-content-between">
                    <div>
                        <h5 class="mb-1">{{ repo.repository_name }}</h5>
                        <span class="badge bg-{% if repo.is_monitored %}success{% else %}info{% endif %}">
                            {% if repo.is_monitored %}Monitored{% else %}Not Monitored{% endif %}
                        </span>
                    </div>
                    <div>
                        <span class="badge bg-{{ 'success' if repo.scan_status == 'completed' else 'warning' if repo.scan_status == 'scanning' else 'danger' }}">
                            {{ repo.scan_status|upper }}
                        </span>
                    </div>
                </div>
                
                <div class="mt-2">
                    <p class="mb-1"><strong>URL:</strong> <a href="{{ repo.repository_url }}" target="_blank">{{ repo.repository_url }}</a></p>
                    <p class="mb-1"><strong>Added:</strong> {{ repo.added_at.strftime('%Y-%m-%d %H:%M') }}</p>
                    {% if repo.last_scan %}
                    <p class="mb-1"><strong>Last Scan:</strong> {{ repo.last_scan.strftime('%Y-%m-%d %H:%M') }}</p>
                    {% else %}
                    <p class="mb-1"><strong>Last Scan:</strong> Never</p>
                    {% endif %}
                    <p class="mb-1"><strong>Total Findings:</strong> {{ repo.findings_count }}</p>
                </div>
                
                <div class="mt-3">
                    {% if repo.is_monitored %}
                    <button class="btn btn-sm btn-secondary" onclick="toggleMonitoring('{{ repo._id }}', false)">
                        Stop Monitoring
                    </button>
                    {% else %}
                    <button class="btn btn-sm btn-primary" onclick="toggleMonitoring('{{ repo._id }}', true)">
                        Start Monitoring
                    </button>
                    {% endif %}
                    <button class="btn btn-sm btn-danger" onclick="deleteRepository('{{ repo._id }}')">
                        Delete
                    </button>
                    <a href="/repositories/{{ repo._id }}/scan" class="btn btn-sm btn-outline-primary">Manual Scan</a>
                    <a href="/reports?repository={{ repo.repository_name }}" class="btn btn-sm btn-info">View Reports</a>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% else %}
    <div class="alert alert-info mt-4">
        <h4>No repositories monitored yet</h4>
        <p>Add repositories to start monitoring for secrets.</p>
    </div>
    {% endif %}
</div>

<!-- Bootstrap Toast for real-time notifications -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="scanToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <strong class="me-auto">Scan Status</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="toastMessage">
            <!-- Message will be inserted here -->
        </div>
    </div>
</div>

<style>
.repositories-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
}

.card {
    border: 1px solid #e1e4e8;
    border-radius: 6px;
    transition: transform 0.2s;
}

.card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.list-group-item {
    margin-bottom: 1rem;
    border-radius: 6px;
    transition: all 0.2s;
}

.list-group-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.card-body, .list-group-item {
    padding: 1.25rem;
}

.empty-state {
    text-align: center;
    padding: 2rem;
    background-color: #f8f9fa;
    border-radius: 6px;
    margin: 2rem 0;
}

.btn-group {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
}
</style>

<script>
async function toggleMonitoring(repoId, enable) {
    try {
        const response = await fetch(`/api/repositories/${repoId}/monitoring`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ is_monitored: enable })
        });
        
        if (response.ok) {
            showToastNotification(`Monitoring ${enable ? 'enabled' : 'disabled'} successfully!`, true);
            setTimeout(() => location.reload(), 1500);
        } else {
            const errorData = await response.json();
            showToastNotification('Failed to update monitoring: ' + errorData.detail, false);
        }
    } catch (error) {
        console.error('Error updating monitoring status:', error);
        showToastNotification('Error updating monitoring status', false);
    }
}

async function addRepository(name, url) {
    try {
        const response = await fetch('/api/repositories', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ 
                repository_name: name,
                repository_url: url 
            })
        });
        
        if (response.ok) {
            showToastNotification('Repository added to monitoring!', true);
            setTimeout(() => location.reload(), 1500);
        } else {
            const errorData = await response.json();
            showToastNotification('Failed to add repository: ' + errorData.detail, false);
        }
    } catch (error) {
        console.error('Error adding repository:', error);
        showToastNotification('Error adding repository', false);
    }
}

async function deleteRepository(repoId) {
    if (confirm('Are you sure you want to delete this repository? All associated findings will also be deleted.')) {
        try {
            const response = await fetch(`/api/repositories/${repoId}`, {
                method: 'DELETE'
            });
            
            if (response.ok) {
                showToastNotification('Repository deleted!', true);
                setTimeout(() => location.reload(), 1500);
            } else {
                const errorData = await response.json();
                showToastNotification('Failed to delete repository: ' + errorData.detail, false);
            }
        } catch (error) {
            console.error('Error deleting repository:', error);
            showToastNotification('Error deleting repository', false);
        }
    }
}

// Toast notification functions
const toastEl = document.getElementById('scanToast');
const toastBody = document.getElementById('toastMessage');
const toast = new bootstrap.Toast(toastEl);

function showToastNotification(message, isSuccess) {
    toastBody.textContent = message;
    toastBody.className = 'toast-body ' + (isSuccess ? 'text-success' : 'text-danger');
    toast.show();
    
    // Auto-hide after 5 seconds
    setTimeout(() => toast.hide(), 5000);
}

// Initialize any notifications from page load
document.addEventListener('DOMContentLoaded', function() {
    {% if scan_notification %}
        showToastNotification("{{ scan_notification.message }}", {{ 'true' if scan_notification.type == 'success' else 'false' }});
    {% endif %}
    
    // Check for query parameter notifications
    {% if request.query_params.get("scan_started") %}
        showToastNotification("Scan started successfully! You'll receive an email when complete.", true);
    {% endif %}
    
    {% if request.query_params.get("error") == "no_token" %}
        showToastNotification("Failed to start scan: GitHub access token missing", false);
    {% endif %}
});
</script>
{% endblock %}
