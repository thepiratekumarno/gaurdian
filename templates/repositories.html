{% extends "base.html" %} 
{% block title %}Repositories{% endblock %} 
{% block content %}

<div class="container">
    <div class="header">
        <h1>Repository Management</h1>
        <p>Manage your repository monitoring and webhook settings</p>
    </div>

    <!-- Alert Messages -->
    {% if scan_notification %}
    <div class="alert alert--{{ scan_notification.type }}" style="margin-bottom: 2rem;">
        <div class="alert-content">
            <span>{{ scan_notification.message }}</span>
            <button class="alert-close" onclick="clearNotification()">&times;</button>
        </div>
    </div>
    {% endif %}

    <!-- Webhook Setup Section -->
    <div class="card" style="margin-bottom: 2rem; border-left: 4px solid var(--color-warning);">
        <div class="card__body">
            <h3>üîß Organization Webhook Setup</h3>
            <p>To automatically scan new repositories when they are created, set up an organization-level webhook:</p>
            
            <div id="webhook-setup-instructions" style="margin: 1rem 0;">
                <h4>Manual Setup Instructions:</h4>
                <ol>
                    <li>Go to your GitHub organization settings: <code>github.com/organizations/YOUR_ORG/settings/hooks</code></li>
                    <li>Click <strong>"Add webhook"</strong></li>
                    <li>Set <strong>Payload URL</strong> to: 
                        <code id="webhook-url">{{ request.url_root }}github-webhook</code>
                        <button onclick="copyWebhookUrl()" class="btn btn--sm btn--outline" style="margin-left: 0.5rem;">Copy</button>
                    </li>
                    <li>Set <strong>Content type</strong> to: <code>application/json</code></li>
                    <li>Add your <strong>webhook secret</strong> (same as GITHUB_WEBHOOK_SECRET in your .env)</li>
                    <li>Under <strong>"Which events would you like to trigger this webhook?"</strong>, select <strong>"Let me select individual events"</strong></li>
                    <li>Select these events: <strong>Repository</strong>, <strong>Push</strong>, <strong>Pull request</strong></li>
                    <li>Click <strong>"Add webhook"</strong></li>
                </ol>
            </div>

            <div style="background: var(--color-bg-3); padding: 1rem; border-radius: var(--radius-base); margin: 1rem 0;">
                <strong>‚ú® What this enables:</strong>
                <ul style="margin: 0.5rem 0;">
                    <li>‚úÖ Automatically detect when new repositories are created</li>
                    <li>‚úÖ Instantly trigger security scans on new repositories</li>
                    <li>‚úÖ Send email notifications with scan results</li>
                    <li>‚úÖ Monitor all repositories in your organization</li>
                </ul>
            </div>

            <div style="background: var(--color-bg-4); padding: 1rem; border-radius: var(--radius-base);">
                <strong>‚ö†Ô∏è Requirements:</strong>
                <ul style="margin: 0.5rem 0;">
                    <li>You must be an <strong>organization owner</strong> to create organization webhooks</li>
                    <li>Your GitHub token needs <strong>admin:org_hook</strong> permissions</li>
                    <li>The webhook secret must match your GITHUB_WEBHOOK_SECRET environment variable</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Repository List Section -->
    <div class="card">
        <div class="card__body">
            <div class="flex justify-between items-center" style="margin-bottom: 1.5rem;">
                <h2>Your Repositories</h2>
                <button class="btn btn--primary" onclick="showAddRepoModal()">
                    Add Repository
                </button>
            </div>

            {% if repositories %}
                <div class="repository-grid">
                    {% for repo in repositories %}
                    <div class="repository-card card" style="margin-bottom: 1rem;">
                        <div class="card__body">
                            <div class="flex justify-between items-start">
                                <div style="flex: 1;">
                                    <h3 style="margin: 0 0 0.5rem 0;">
                                        <a href="{{ repo.repository_url }}" target="_blank" style="text-decoration: none; color: var(--color-primary);">
                                            {{ repo.repository_name }}
                                        </a>
                                        {% if repo.webhook_auto_created %}
                                            <span class="status status--success" style="margin-left: 0.5rem; font-size: var(--font-size-xs);">Auto-detected</span>
                                        {% endif %}
                                    </h3>
                                    
                                    <div class="repository-meta">
                                        <p><strong>URL:</strong> {{ repo.repository_url }}</p>
                                        {% if repo.last_scan %}
                                            <p><strong>Last Scan:</strong> {{ repo.last_scan.strftime('%Y-%m-%d %H:%M') }}</p>
                                        {% else %}
                                            <p><strong>Last Scan:</strong> Never</p>
                                        {% endif %}
                                        <p><strong>Total Findings:</strong> {{ repo.findings_count or 0 }}</p>
                                        {% if repo.scanned_files_count %}
                                            <p><strong>Files Scanned:</strong> {{ repo.scanned_files_count }}</p>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="repository-actions" style="display: flex; flex-direction: column; gap: 0.5rem;">
                                    <!-- Scan Status -->
                                    {% if repo.scan_status == 'scanning' %}
                                        <span class="status status--warning">
                                            <span class="loading-spinner"></span> Scanning...
                                        </span>
                                    {% elif repo.scan_status == 'completed' %}
                                        <span class="status status--success">‚úÖ Complete</span>
                                    {% elif repo.scan_status == 'failed' %}
                                        <span class="status status--error">‚ùå Failed</span>
                                    {% else %}
                                        <span class="status status--info">‚è≥ Pending</span>
                                    {% endif %}

                                    <!-- Monitoring Toggle -->
                                    <label class="monitoring-toggle">
                                        <input type="checkbox" 
                                               {% if repo.is_monitored %}checked{% endif %}
                                               onchange="toggleMonitoring('{{ repo._id }}', this.checked)">
                                        <span>Monitor</span>
                                    </label>

                                    <!-- Manual Scan Button -->
                                    <a href="/repositories/{{ repo._id }}/scan" 
                                       class="btn btn--sm btn--outline"
                                       onclick="this.innerHTML='Scanning...'; this.style.pointerEvents='none';">
                                        üîç Manual Scan
                                    </a>

                                    <!-- Delete Button -->
                                    <button class="btn btn--sm btn--outline" 
                                            onclick="deleteRepository('{{ repo._id }}', '{{ repo.repository_name }}')"
                                            style="color: var(--color-error); border-color: var(--color-error);">
                                        üóëÔ∏è Delete
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="empty-state" style="text-align: center; padding: 3rem 1rem;">
                    <h3>No repositories found</h3>
                    <p>Add repositories to start monitoring for secrets, or set up an organization webhook to automatically detect new repositories.</p>
                    <div style="margin-top: 1rem;">
                        <button class="btn btn--primary" onclick="showAddRepoModal()">Add Your First Repository</button>
                    </div>
                </div>
            {% endif %}

            {% if github_repos %}
                <div style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid var(--color-border);">
                    <h3>GitHub Repositories Available</h3>
                    <p>These repositories from your GitHub account can be added for monitoring:</p>
                    
                    <div class="github-repos-grid">
                        {% for github_repo in github_repos %}
                        <div class="github-repo-card" style="padding: 1rem; border: 1px solid var(--color-border); border-radius: var(--radius-base); margin-bottom: 0.5rem;">
                            <div class="flex justify-between items-center">
                                <div>
                                    <strong>{{ github_repo.full_name }}</strong>
                                    <span class="status status--info" style="margin-left: 0.5rem;">
                                        {{ "üîí Private" if github_repo.private else "üåç Public" }}
                                    </span>
                                </div>
                                <button class="btn btn--sm btn--primary" 
                                        onclick="addGitHubRepo('{{ github_repo.full_name }}', '{{ github_repo.html_url }}')">
                                    Add to Monitoring
                                </button>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Add Repository Modal -->
<div id="add-repo-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Add Repository</h3>
            <button class="modal-close" onclick="hideAddRepoModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="add-repo-form">
                <div class="form-group">
                    <label class="form-label">Repository Name (owner/repo)</label>
                    <input type="text" id="repo-name" class="form-control" 
                           placeholder="e.g., username/my-repo" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Repository URL</label>
                    <input type="url" id="repo-url" class="form-control" 
                           placeholder="https://github.com/username/my-repo" required>
                </div>
                <div style="text-align: right;">
                    <button type="button" class="btn btn--secondary" onclick="hideAddRepoModal()">Cancel</button>
                    <button type="submit" class="btn btn--primary">Add Repository</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Copy webhook URL to clipboard
function copyWebhookUrl() {
    const webhookUrl = document.getElementById('webhook-url').textContent;
    navigator.clipboard.writeText(webhookUrl).then(() => {
        showAlert('Webhook URL copied to clipboard!', 'success');
    });
}

// Show/hide add repository modal
function showAddRepoModal() {
    document.getElementById('add-repo-modal').style.display = 'flex';
}

function hideAddRepoModal() {
    document.getElementById('add-repo-modal').style.display = 'none';
    document.getElementById('add-repo-form').reset();
}

// Add repository
document.getElementById('add-repo-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const repoName = document.getElementById('repo-name').value;
    const repoUrl = document.getElementById('repo-url').value;
    
    try {
        const response = await fetch('/api/repositories', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                repository_name: repoName,
                repository_url: repoUrl
            })
        });
        
        if (response.ok) {
            hideAddRepoModal();
            showAlert('Repository added successfully! Scan will begin automatically.', 'success');
            setTimeout(() => location.reload(), 2000);
        } else {
            const error = await response.json();
            showAlert('Error adding repository: ' + error.detail, 'error');
        }
    } catch (error) {
        showAlert('Error adding repository: ' + error.message, 'error');
    }
});

// Add GitHub repository
async function addGitHubRepo(fullName, htmlUrl) {
    try {
        const response = await fetch('/api/repositories', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                repository_name: fullName,
                repository_url: htmlUrl
            })
        });
        
        if (response.ok) {
            showAlert('Repository added successfully! Scan will begin automatically.', 'success');
            setTimeout(() => location.reload(), 2000);
        } else {
            const error = await response.json();
            showAlert('Error adding repository: ' + error.detail, 'error');
        }
    } catch (error) {
        showAlert('Error adding repository: ' + error.message, 'error');
    }
}

// Toggle monitoring
async function toggleMonitoring(repoId, enabled) {
    try {
        const response = await fetch(`/api/repositories/${repoId}/monitoring`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                is_monitored: enabled
            })
        });
        
        if (response.ok) {
            showAlert(enabled ? 'Monitoring enabled' : 'Monitoring disabled', 'success');
        } else {
            const error = await response.json();
            showAlert('Error updating monitoring: ' + error.detail, 'error');
            location.reload();
        }
    } catch (error) {
        showAlert('Error updating monitoring: ' + error.message, 'error');
        location.reload();
    }
}

// Delete repository
async function deleteRepository(repoId, repoName) {
    if (!confirm(`Are you sure you want to delete "${repoName}" from monitoring?`)) {
        return;
    }
    
    try {
        const response = await fetch(`/api/repositories/${repoId}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            showAlert('Repository deleted successfully', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            const error = await response.json();
            showAlert('Error deleting repository: ' + error.detail, 'error');
        }
    } catch (error) {
        showAlert('Error deleting repository: ' + error.message, 'error');
    }
}

// Alert system
function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert--${type}`;
    alertDiv.innerHTML = `
        <div class="alert-content">
            <span>${message}</span>
            <button class="alert-close" onclick="this.parentElement.parentElement.remove()">&times;</button>
        </div>
    `;
    
    const container = document.querySelector('.container');
    container.insertBefore(alertDiv, container.firstChild);
    
    setTimeout(() => {
        if (alertDiv.parentElement) {
            alertDiv.remove();
        }
    }, 5000);
}

// Clear notification
async function clearNotification() {
    try {
        await fetch('/clear-scan-notification', { method: 'POST' });
        document.querySelector('.alert').remove();
    } catch (error) {
        console.error('Error clearing notification:', error);
    }
}
</script>

<style>
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
    align-items: center;
    justify-content: center;
}

.modal-content {
    background-color: var(--color-surface);
    border-radius: var(--radius-lg);
    max-width: 500px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.5rem;
    border-bottom: 1px solid var(--color-border);
}

.modal-header h3 {
    margin: 0;
}

.modal-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: var(--color-text-secondary);
}

.modal-body {
    padding: 1.5rem;
}

.repository-grid {
    display: grid;
    gap: 1rem;
}

.repository-card {
    transition: box-shadow var(--duration-fast) ease;
}

.repository-card:hover {
    box-shadow: var(--shadow-md);
}

.repository-meta {
    color: var(--color-text-secondary);
    font-size: var(--font-size-sm);
}

.repository-meta p {
    margin: 0.25rem 0;
}

.monitoring-toggle {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: var(--font-size-sm);
}

.monitoring-toggle input[type="checkbox"] {
    margin: 0;
}

.github-repos-grid {
    max-height: 400px;
    overflow-y: auto;
}

.empty-state {
    color: var(--color-text-secondary);
}

.alert {
    padding: 1rem;
    border-radius: var(--radius-base);
    margin-bottom: 1rem;
    border: 1px solid;
}

.alert--success {
    background-color: rgba(var(--color-success-rgb), 0.1);
    border-color: var(--color-success);
    color: var(--color-success);
}

.alert--error {
    background-color: rgba(var(--color-error-rgb), 0.1);
    border-color: var(--color-error);
    color: var(--color-error);
}

.alert--warning {
    background-color: rgba(var(--color-warning-rgb), 0.1);
    border-color: var(--color-warning);
    color: var(--color-warning);
}

.alert-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.alert-close {
    background: none;
    border: none;
    font-size: 1.2rem;
    cursor: pointer;
    margin-left: 1rem;
}

.loading-spinner {
    display: inline-block;
    width: 12px;
    height: 12px;
    border: 2px solid var(--color-warning);
    border-top: 2px solid transparent;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>

{% endblock %}
